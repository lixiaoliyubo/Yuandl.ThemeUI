name: WPF Auto Release

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOTNET_VERSION: '8.x'  # æ ¹æ®é¡¹ç›®è°ƒæ•´ .NET ç‰ˆæœ¬
  BUILD_CONFIGURATION: 'Release'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest  # WPFå¿…é¡»ä½¿ç”¨Windowsç¯å¢ƒ

    steps:
      # Step 1 - æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2 - è®¾ç½® .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Step 3 - æ„å»ºå¹¶å‘å¸ƒWPFåº”ç”¨
      - name: Build WPF Project
        run: |
          dotnet restore ./Yuandl.ThemeUI.sln
          dotnet build ./Yuandl.ThemeUI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
          dotnet publish ./Yuandl.ThemeUI/src/Yuandl.ThemeUI.csproj \
            --configuration ${{ env.BUILD_CONFIGURATION }} \
            --output ./publish \
            --runtime win-x64 \             # æŒ‡å®šç›®æ ‡è¿è¡Œæ—¶
            --self-contained true \         # åŒ…å«å®Œæ•´è¿è¡Œæ—¶
            -p:PublishSingleFile=true       # ç”Ÿæˆå•æ–‡ä»¶

      # Step 4 - å°†äº§ç‰©æ‰“åŒ…ä¸ºZIP
      - name: Create Release Package
        shell: powershell
        run: |
          $version = (Get-Item ./YourWpfProject/bin/${{ env.BUILD_CONFIGURATION }}/net7.0-windows/YourWpfProject.exe).VersionInfo.FileVersion
          Compress-Archive -Path ./publish/* -DestinationPath "./Yuandl.ThemeUI_${version}.zip"
          echo "BUILD_VERSION=$version" >> $env:GITHUB_ENV

      # Step 5 - ç”Ÿæˆå˜æ›´æ—¥å¿—
      - name: Generate Changelog
        id: changelog
        run: |
          git fetch --prune --unshallow  # ç¡®ä¿è·å–å®Œæ•´å†å²
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --since="3 days ago" --pretty=format:"- [%h] %s (%an, %ad)" --date=short >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 6 - åˆ›å»ºReleaseå¹¶ä¸Šä¼ äºŒè¿›åˆ¶
      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.BUILD_VERSION }}  # ä½¿ç”¨æ–‡ä»¶ç‰ˆæœ¬ä½œä¸ºæ ‡ç­¾
          name: YourApp ${{ env.BUILD_VERSION }}
          draft: true
          prerelease: false
          body: |
            ### ğŸ“¦ æ–°åŠŸèƒ½ & ä¿®å¤
            ${{ steps.changelog.outputs.CHANGELOG }}

            ### ç‰ˆæœ¬ä¿¡æ¯
            - ç¼–è¯‘æ—¶é—´: ${{ steps.generate_date.outputs.DATE }}
            - æäº¤ç‚¹: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          files: |
            YourWpfProject_${{ env.BUILD_VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
