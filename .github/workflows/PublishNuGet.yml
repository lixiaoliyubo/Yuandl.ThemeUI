name: WPF Auto Release

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:  # 允许手动触发

env:
  DOTNET_VERSION: '8.x'  # 根据项目调整 .NET 版本
  BUILD_CONFIGURATION: 'Release'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest  # WPF必须使用Windows环境

    steps:
      # Step 1 - 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2 - 设置 .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Step 3 - 构建并发布WPF应用
      - name: Build WPF Project
        run: |
          dotnet restore ./Yuandl.ThemeUI.sln
          dotnet build ./Yuandl.ThemeUI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
          dotnet publish ./Yuandl.ThemeUI/src/Yuandl.ThemeUI.csproj \
            --configuration ${{ env.BUILD_CONFIGURATION }} \
            --output ./publish \
            --runtime win-x64 \             # 指定目标运行时
            --self-contained true \         # 包含完整运行时
            -p:PublishSingleFile=true       # 生成单文件

      # Step 4 - 将产物打包为ZIP
      - name: Create Release Package
        shell: powershell
        run: |
          $version = (Get-Item ./YourWpfProject/bin/${{ env.BUILD_CONFIGURATION }}/net7.0-windows/YourWpfProject.exe).VersionInfo.FileVersion
          Compress-Archive -Path ./publish/* -DestinationPath "./Yuandl.ThemeUI_${version}.zip"
          echo "BUILD_VERSION=$version" >> $env:GITHUB_ENV

      # Step 5 - 生成变更日志
      - name: Generate Changelog
        id: changelog
        run: |
          git fetch --prune --unshallow  # 确保获取完整历史
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --since="3 days ago" --pretty=format:"- [%h] %s (%an, %ad)" --date=short >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 6 - 创建Release并上传二进制
      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.BUILD_VERSION }}  # 使用文件版本作为标签
          name: YourApp ${{ env.BUILD_VERSION }}
          draft: true
          prerelease: false
          body: |
            ### 📦 新功能 & 修复
            ${{ steps.changelog.outputs.CHANGELOG }}

            ### 版本信息
            - 编译时间: ${{ steps.generate_date.outputs.DATE }}
            - 提交点: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          files: |
            YourWpfProject_${{ env.BUILD_VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
