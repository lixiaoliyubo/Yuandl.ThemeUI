name: WPF Multi-Target Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: 'Release'
  SAMPLE_PROJECT: 'src/YuandlThemeUI.Sample/YuandlThemeUI.Sample.csproj'
  UI_LIB_PROJECT: 'src/Yuandl.ThemeUI/Yuandl.ThemeUI.csproj'

permissions:
  contents: write
  packages: write  # 启用包写入权限[^1]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        target_framework: ['net462', 'net48', 'net6.0-windows', 'net8.0-windows']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
            6.0.x
            8.0.x  # 指定目标框架对应SDK版本[^2]

      - name: Install .NET Framework Targets
        if: contains(matrix.target_framework, 'net4')
        run: choco install netfx-4.8-devpack -y
        shell: powershell

      - name: Clean workspace
        run: Remove-Item -Recurse -Force src/Yuandl.ThemeUI/obj, src/Yuandl.ThemeUI/bin -ErrorAction SilentlyContinue
        shell: powershell

      - name: Build library
        run: dotnet build ${{ env.UI_LIB_PROJECT }} -f ${{ matrix.target_framework }} --configuration ${{ env.BUILD_CONFIGURATION }}

  pack:
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x  # 使用稳定版SDK打包[^3]

      - name: Get version
        id: get_version
        shell: powershell
        run: |
          $xml = [xml](Get-Content ${{ env.UI_LIB_PROJECT }})
          $version = $xml.Project.PropertyGroup.AssemblyVersion
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Create NuGet package
        run: |
          dotnet pack ${{ env.UI_LIB_PROJECT }} \
            --configuration ${{ env.BUILD_CONFIGURATION }} \
            --output ./nupkg \
            -p:PackageVersion=${{ steps.get_version.outputs.version }} \
            --include-symbols  # 包含符号文件[^4]

      - name: Publish package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg/*.nupkg
